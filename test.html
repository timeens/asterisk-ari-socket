<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
</head>
<body>

<script>

	var ws = null;

	function init() {
		var el = document.getElementById('output');
		el.innerHTML = '';
		output('Refreshing connection...');
		var sip = document.getElementById('sip').value;

		ws = new WebSocket('ws://localhost:8088');

		ws.onopen = function () {
			output('Client: sending ready event');
			var action = {
				name: 'HANDSHAKE',
				params: {
					sipNr: sip
				}
			};
			ws.send(JSON.stringify(action));
		};
		ws.onmessage = function (msg) {
			var event = JSON.parse(msg.data);
			console.log(event);
			var string = event.name;
			if (event.name === 'ERROR') {
				string = 'ERROR: ';
				event.errors.map(function (e, i) {
					i++;
					string = string + i + '. => Code: ' + e.code;
					if (e.data) string = string + ' (Data: ' + e.data + ')';
				});
			}
			if(event.params) string = string + ' params => ' + JSON.stringify(event.params);
			output('Server: ' + string);
		};
		ws.onerror = function (err) {
			output(err);
		};
		ws.onclose = function () {
			output("connection closed");
		};
	}

	function call() {
		var phoneNb = document.getElementById('phone').value;
		var action = {
			name: 'OUTBOUND_CALL',
			params: {
				remoteEndpoint: phoneNb
			}
		};
		ws.send(JSON.stringify(action));
	}

	function hangup(){
		var action = {
			name: 'HANGUP'
		};
		ws.send(JSON.stringify(action));
	}


	function output(msg) {
		var el = document.getElementById('output');
		el.innerHTML = el.innerHTML + "<br>" + msg;
	}
</script>

<input id="sip" placeholder="sip nb" value="308">
<button onclick="init()">Init</button>

<input id="phone" placeholder="phone nb" value="+41763229207">
<button onclick="call()">Call</button>

<button onclick="hangup()">Hang Up</button>

<div id="output"></div>

</body>
</html>